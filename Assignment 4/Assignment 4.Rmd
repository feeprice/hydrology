---
title: "Assignment 4"
author: "Fiona Price"
date: "2024-11-25"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
#10-YEAR DROUGHT

```{r setup, include=FALSE}
#Load in packages
library(here)
library(tidyr)
library(lubridate)
library(dplyr)
library(zoo)

flows <- read.csv(file = 
    here("./Assignment 4/Data Raw/neuse_river_at_clayton_02087500_daily_flow_updated.csv"),
    stringsAsFactors = TRUE)
```

```{r, 10-year drought, 1981 and beyond} 
filtered_flows <- flows %>% 
  filter(flows$year >= 1981)

#Calculate moving average for inflow
moving_avg_flows <- rollmean(filtered_flows$daily_mean_discharge_cfs, 
                              k = 7, fill = NA, align = "center")

#Turn into df 
flows <- data.frame(
  flows = filtered_flows,
  moving_avg = moving_avg_flows)

#Find minimum for each year
flow_mins <- flows %>% 
  group_by(flows.year) %>% 
  summarise(yearly_min = min(moving_avg))

#Rank
flow_mins <- flow_mins %>% 
  mutate(rank = rank(yearly_min,
                        ties.method = "min"))

#Find return period
drought_rp <- flow_mins %>% 
  mutate(number_events = 98) %>% 
  mutate(plotting_position = (100*(2*rank - 1))/(number_events)) %>% 
  mutate(return_period = (number_events + 1)/rank)
```

```{r 10-year drought, 1981-2000} 
#Filter the minimum per year inflow df to only include 1981-2000.
early_flows <- flows %>% 
  filter(year >= 1981 & year <= 2000)

#Calculate moving average for inflow
moving_avg_early <- rollmean(early_flows$daily_mean_discharge_cfs, 
                              k = 7, fill = NA, align = "center")
#Turn into df 
early_flows <- data.frame(
  flows = early_flows,
  moving_avg = moving_avg_early)

#Find minimum for each year
early_flow_mins <- early_flows %>% 
  group_by(flows.year) %>% 
  summarise(yearly_min = min(moving_avg))

#Rank
early_flow_mins <- early_flow_mins %>% 
  mutate(rank = rank(yearly_min,
                        ties.method = "min"))

#Find return period
early_drought_rp <- early_flow_mins %>% 
  mutate(number_events = 20) %>% 
  mutate(plotting_position = (100*(2*rank - 1))/(number_events)) %>% 
  mutate(return_period = (number_events + 1)/rank)
```

```{r 10-year drought, 2000 to present} 
#Filter the minimum per year inflow df to only include 2000 and beyond
late_flows <- flows %>% 
  filter(year > 2000)

#Calculate moving average for inflow
moving_avg_late <- rollmean(late_flows$daily_mean_discharge_cfs, 
                              k = 7, fill = NA, align = "center")
#Turn into df 
late_flows <- data.frame(
  flows = late_flows,
  moving_avg = moving_avg_late)

#Find minimum for each year
late_flow_mins <- late_flows %>% 
  group_by(flows.year) %>% 
  summarise(yearly_min = min(moving_avg))

#Rank
late_flow_mins <- late_flow_mins %>% 
  mutate(rank = rank(yearly_min,
                        ties.method = "min"))

#Find return period
late_drought_rp <- late_flow_mins %>% 
  mutate(number_events = 24) %>% 
  mutate(plotting_position = (100*(2*rank - 1))/(number_events)) %>% 
  mutate(return_period = (number_events + 1)/rank)
```

```{r 50-year flood}
#Rank all events
flood_flows <- flows %>% 
  filter(year >= 1981) %>% 
  mutate(rank = rank(-daily_mean_discharge_cfs,
                     ties.method = "max"))

flood_rp <- flood_flows %>% 
  mutate(number_events = nrow(flood_flows)) %>% 
  mutate(return_period = (number_events + 1)/rank)
```

```{r 50-year flood, 1981-2000}
#Rank all events
early_flood_flows <- flows %>% 
  filter(year >= 1981 & year <= 2000) %>% 
  mutate(rank = rank(-daily_mean_discharge_cfs,
                     ties.method = "max"))

early_flood_rp <- early_flood_flows %>% 
  mutate(number_events = nrow(flood_flows)) %>% 
  mutate(return_period = (number_events + 1)/rank)
```

```{r 50-year flood, 2001-2024}
#Rank all events
late_flood_flows <- flows %>% 
  filter(year > 2000) %>% 
  mutate(rank = rank(-daily_mean_discharge_cfs,
                     ties.method = "max"))

#Find return period
late_flood_rp <- late_flood_flows %>% 
  mutate(number_events = nrow(flood_flows)) %>% 
  mutate(return_period = (number_events + 1)/rank)
```

```{r comparing mean discharge and max discharge, floods}
#Only have max flow data for 2004 and beyond. Filter to only include those years.
mean_max_flows <- flows %>% 
  filter(flows.year >= 2004)

#Rank all events (mean daily discharge)
mean_flows <- mean_max_flows %>% 
  mutate(rank = rank(-flows.daily_mean_discharge_cfs,
                     ties.method = "max"))

#Find return period (mean daily discharge)
mean_flood_rp <- mean_flows %>% 
  mutate(number_events = nrow(mean_flows)) %>% 
  mutate(return_period = (number_events + 1)/rank)

#Rank all events (max daily discharge)
max_flows <- mean_max_flows %>% 
  mutate(rank = rank(-flows.daily_max_discharge_cfs,
                     ties.method = "max"))

#Find return period (max daily discharge)
max_flood_rp <- max_flows %>% 
  mutate(number_events = nrow(max_flows)) %>% 
  mutate(return_period = (number_events + 1)/rank)

```
